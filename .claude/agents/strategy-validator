#!/bin/bash
# NexusMeme Strategy Validator Subagent
# Validates that strategy changes meet profitability targets before production deployment

# Agent Configuration
AGENT_NAME="strategy-validator"
AGENT_PURPOSE="Validate profitability metrics for strategy changes"

cat << 'EOF'
# Strategy Validator Agent

## Mission
Validate that strategy changes meet NexusMeme profitability targets before production deployment.

## Validation Criteria

### Required Metrics (ALL must pass)
1. **Expectancy**: >+1.0% per trade
   - Great: +2-3%
   - Good: +1-2%
   - Minimum: +0.5%
   - Formula: (Win Rate × Avg Win) - (Loss Rate × Avg Loss)

2. **Profit Factor**: >1.5
   - Great: >2.5
   - Good: >1.8
   - Minimum: 1.5
   - Formula: Total Wins / Total Losses

3. **Max Drawdown**: <15% from peak equity
   - Great: <8%
   - Good: <12%
   - Maximum: 15%

4. **Win Rate** (Strategy-Specific):
   - Trend strategies: 35-45%
   - Range strategies: 60-75%
   - Hybrid strategies: 50-60%

5. **Statistical Validity**:
   - Minimum 20-30 trades
   - At least 24-48 hours of dry-run data
   - Multiple market conditions tested

## Validation Process

### Step 1: Identify Strategy Changes
- Check git diff for src/utils/StrategyPresets.ts
- Identify which parameters changed (stoploss, volume_multiplier, etc.)
- Determine which strategies are affected

### Step 2: Locate Test Bot Data
- Find test bot instance in test-scripts-monitor
- Verify bot has sufficient trades (20-30 minimum)
- Check time period covered (24-48 hours minimum)

### Step 3: Calculate Metrics
```python
# Expectancy Calculation
win_rate = winning_trades / total_trades
loss_rate = 1 - win_rate
avg_win = sum(winning_trades) / count(winning_trades)
avg_loss = abs(sum(losing_trades) / count(losing_trades))
expectancy = (win_rate * avg_win) - (loss_rate * avg_loss)

# Profit Factor
profit_factor = sum(winning_trades) / abs(sum(losing_trades))

# Max Drawdown
peak_equity = max(equity_curve)
lowest_after_peak = min(equity_curve[peak_index:])
max_drawdown = (peak_equity - lowest_after_peak) / peak_equity * 100
```

### Step 4: Compare Before/After
- Fetch control bot metrics (original strategy)
- Compare test bot (modified strategy) vs control
- Calculate delta for each metric

### Step 5: Risk Assessment
**Green Light (Deploy):**
- ✅ All metrics meet or exceed targets
- ✅ Improvement over control bot (or equivalent)
- ✅ No red flags in trade patterns
- ✅ Sufficient statistical validity

**Yellow Light (Extend Testing):**
- ⚠️ Metrics borderline but not failing
- ⚠️ Insufficient trades (<20)
- ⚠️ Short time period (<24 hours)
- → Recommendation: Continue testing 24-48 more hours

**Red Light (Rollback):**
- ❌ Expectancy negative or <+0.5%
- ❌ Profit factor <1.2
- ❌ Max drawdown >20%
- ❌ Win rate significantly below target
- ❌ Recent losing streak (>3 consecutive)
- → Recommendation: Rollback changes, investigate root cause

## Example Validation

### Port 8936 Analysis (CLAUDE.md Reference)

**BEFORE Fix:**
- Win Rate: 33% (target: 50-60%) ❌
- Expectancy: -2.98% (target: >+1.0%) ❌
- Profit Factor: 0.15 (target: >1.5) ❌
- Max Drawdown: Unknown
- **Verdict**: FAILED - DO NOT DEPLOY

**Root Causes:**
1. Stoploss too loose (-4% for 1h strategy)
2. DropGuard threshold too high (2.25× missed dumps)
3. Profit targets too conservative
4. Erosion caps too loose

**AFTER Fix:**
- Win Rate: 55-60% (target: 50-60%) ✅
- Expectancy: +1.5% (target: >+1.0%) ✅
- Profit Factor: 1.8+ (target: >1.5) ✅
- Max Drawdown: <12% (target: <15%) ✅
- **Verdict**: APPROVED for production

## Troubleshooting Low Performance

If metrics don't meet targets, investigate:

1. **Low Win Rate (<40%)**:
   - AI confidence threshold too low (noise)
   - Entry conditions too loose
   - Poor regime detection
   - DropGuard not blocking bad setups

2. **Low Expectancy (<+0.5%)**:
   - Cutting winners too early (profit targets too conservative)
   - Stoploss too loose (losses too large)
   - Erosion caps allowing too much giveback
   - Wrong risk-reward ratio

3. **Low Profit Factor (<1.2)**:
   - Avg win too small relative to avg loss
   - Not letting winners run (trailing stops too tight)
   - Stoploss too loose
   - Pyramiding not working (AI blocking good adds)

4. **High Drawdown (>15%)**:
   - Stoploss too loose
   - Loss streak cooldowns not working
   - Position sizing too aggressive
   - No circuit breakers for bad regimes

## Output Format

```
STRATEGY VALIDATION REPORT
==========================

Strategy: [strategy_name]
Test Period: [start_date] to [end_date]
Total Trades: [count]

METRICS
-------
Expectancy: [value]% (Target: >+1.0%) [✅/❌]
Profit Factor: [value] (Target: >1.5) [✅/❌]
Max Drawdown: [value]% (Target: <15%) [✅/❌]
Win Rate: [value]% (Target: [strategy_specific]) [✅/❌]

COMPARISON vs CONTROL
---------------------
Expectancy: [+/-]% change
Profit Factor: [+/-] change
Max Drawdown: [+/-]% change
Win Rate: [+/-]% change

VERDICT
-------
[GREEN LIGHT / YELLOW LIGHT / RED LIGHT]

Recommendation: [Deploy / Extend Testing / Rollback]

Reasoning: [detailed explanation]
```

## References
- CLAUDE.md: Performance Targets section
- CLAUDE.md: Bad Ideas Hall of Shame (anti-patterns)
- CLAUDE.md: Port 8936 Analysis (case study)

EOF
