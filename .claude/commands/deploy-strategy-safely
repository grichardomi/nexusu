#!/bin/bash
# Custom Claude Code command for safe strategy deployment
# Usage: /deploy-strategy-safely

set -e

echo "ðŸš€ NexusMeme Safe Strategy Deployment Workflow"
echo "=================================================="
echo ""

echo "ðŸ” Step 1: Verify StrategyPresets.ts Changes"
echo "--------------------------------------------"
if git diff --quiet src/utils/StrategyPresets.ts; then
  echo "âš ï¸  WARNING: No changes detected in StrategyPresets.ts"
  echo "   Are you sure you modified the correct file?"
else
  echo "âœ… Changes detected in StrategyPresets.ts:"
  git diff src/utils/StrategyPresets.ts | head -20
  echo "   (showing first 20 lines...)"
fi
echo ""

echo "ðŸ§ª Step 2: Verify DynamicStrategyProcessor.ts (No Unintended Changes)"
echo "-----------------------------------------------------------------------"
if git diff --quiet src/utils/DynamicStrategyProcessor.ts; then
  echo "âœ… DynamicStrategyProcessor.ts unchanged (expected)"
else
  echo "âš ï¸  WARNING: DynamicStrategyProcessor.ts has changes!"
  echo "   This could affect ALL strategies. Review carefully:"
  git diff src/utils/DynamicStrategyProcessor.ts | head -15
fi
echo ""

echo "ðŸ”§ Step 3: Type Check"
echo "--------------------"
pnpm run type-check 2>&1 | tail -5
echo ""

echo "ðŸ“Š Step 4: Create Test Bot"
echo "--------------------------"
echo "ðŸ‘‰ Visit: http://localhost:3000/test-scripts-monitor"
echo "ðŸ‘‰ Create bot with modified strategy"
echo "ðŸ‘‰ Wait for at least 24-48 hours of dry-run data"
echo ""

echo "ðŸŽ¯ Step 5: Verify Target Metrics (Before Production Deploy)"
echo "------------------------------------------------------------"
echo "Required Metrics for Production Deployment:"
echo "  âœ… Expectancy: >+1.0% per trade (Great: +2-3%)"
echo "  âœ… Profit Factor: >1.5 (Great: >2.5)"
echo "  âœ… Max Drawdown: <15% from peak equity"
echo "  âœ… Win Rate: Strategy-specific"
echo "     - Trend: 35-45%"
echo "     - Range: 60-75%"
echo "     - Hybrid: 50-60%"
echo ""

echo "âš¡ Step 6: Deploy to Production (Only if metrics pass)"
echo "-------------------------------------------------------"
echo "  1. Commit changes: git add src/utils/StrategyPresets.ts"
echo "  2. Create commit: git commit -m 'strategy: improve [strategy_name] parameters'"
echo "  3. Push to Railway: git push origin master"
echo "  4. Monitor live bot performance for 48-72 hours"
echo ""

echo "âŒ Rollback Plan (If Production Performance Degrades)"
echo "------------------------------------------------------"
echo "  1. Revert commit: git revert HEAD"
echo "  2. Push rollback: git push origin master"
echo "  3. Update CLAUDE.md with findings"
echo ""

echo "ðŸ“ Remember: ALWAYS test on single strategy first, NEVER make universal changes without testing!"
