#!/bin/bash
# Custom Claude Code command for single strategy testing
# Usage: /test-single-strategy

set -e

echo "ðŸ§ª NexusMeme Single Strategy Testing Workflow"
echo "=============================================="
echo ""

echo "âš ï¸  CRITICAL: Never make universal changes without testing on single strategy first!"
echo ""

echo "ðŸ“‹ Step 1: Identify Strategy to Test"
echo "------------------------------------"
echo "Available Long Strategies (from StrategyPresets.ts):"
echo "  1. hedge_fund_envy (1h) - Trend-following with AI validation"
echo "  2. nexus_money_printer (1h) - Momentum breakout"
echo "  3. capital_preservation_engine (1h) - Conservative range trading"
echo "  4. expectancy_maximizer (4h) - Long-term trend capture"
echo ""
echo "Choose ONE strategy to test your changes on."
echo ""

echo "ðŸ”§ Step 2: Modify StrategyPresets.ts for SINGLE Strategy"
echo "--------------------------------------------------------"
echo "Example: Testing new stoploss for hedge_fund_envy only"
echo ""
echo "âŒ WRONG (Universal Change):"
echo "   // Changed stoploss for ALL strategies"
echo "   stoploss: -0.015,"
echo ""
echo "âœ… CORRECT (Single Strategy):"
echo "   if (strategyName === 'hedge_fund_envy') {"
echo "     stoploss: -0.015,  // Testing new value"
echo "   } else {"
echo "     stoploss: -0.04,   // Keep original for others"
echo "   }"
echo ""

echo "ðŸ§ª Step 3: Create Test Bot"
echo "--------------------------"
echo "1. Visit: http://localhost:3000/test-scripts-monitor"
echo "2. Select the strategy you modified"
echo "3. Create test bot with dry-run mode"
echo "4. Verify generated strategy file has your changes"
echo ""

echo "â±ï¸  Step 4: Run Test for Minimum 24-48 Hours"
echo "--------------------------------------------"
echo "Why 24-48 hours?"
echo "  - 1h strategies: Need ~24-48 candles for statistical validity"
echo "  - 4h strategies: Need ~6-12 candles for initial assessment"
echo "  - Market conditions: Need to see different regimes (choppy, trending)"
echo ""

echo "ðŸ“Š Step 5: Monitor Test Results"
echo "-------------------------------"
echo "Track these metrics in real-time:"
echo "  - Trade count (minimum 20-30 for validity)"
echo "  - Win rate (strategy-specific targets)"
echo "  - Expectancy (target: >+1.0%)"
echo "  - Profit factor (target: >1.5)"
echo "  - Max drawdown (target: <15%)"
echo "  - AI validation rate (should be consistent)"
echo ""

echo "âœ… Step 6: Evaluate Results"
echo "---------------------------"
echo "If metrics IMPROVE:"
echo "  1. Document findings in commit message"
echo "  2. Consider expanding to similar strategies"
echo "  3. Test next strategy individually"
echo "  4. Once validated across 2-3 strategies, make universal"
echo ""
echo "If metrics DEGRADE:"
echo "  1. Rollback changes in StrategyPresets.ts"
echo "  2. Analyze what went wrong"
echo "  3. Update CLAUDE.md 'Bad Ideas Hall of Shame'"
echo "  4. Try alternative approach"
echo ""

echo "ðŸ”„ Step 7: Compare Test vs Control"
echo "----------------------------------"
echo "Best Practice: Run TWO bots simultaneously"
echo "  - Bot A: Modified strategy (test)"
echo "  - Bot B: Original strategy (control)"
echo ""
echo "Compare after 48 hours:"
echo "  - Did test bot outperform control?"
echo "  - Is improvement statistically significant?"
echo "  - Are trade patterns consistent with hypothesis?"
echo ""

echo "ðŸ“ˆ Step 8: Gradual Rollout"
echo "-------------------------"
echo "If single strategy test succeeds:"
echo "  1. Expand to 2nd similar strategy â†’ Test 24-48h"
echo "  2. Expand to 3rd similar strategy â†’ Test 24-48h"
echo "  3. If all succeed â†’ Make universal change"
echo "  4. Deploy to production with monitoring"
echo ""

echo "ðŸš¨ Anti-Pattern Examples (From CLAUDE.md)"
echo "-----------------------------------------"
echo ""
echo "âŒ BAD: 'Let's lower AI threshold globally to 50%'"
echo "   Result: More trades but expectancy collapses"
echo "   Lesson: Test on ONE strategy first, measure impact"
echo ""
echo "âŒ BAD: 'Disable all stop losses to let winners run'"
echo "   Result: Small losses become catastrophic (-20%, -40%)"
echo "   Lesson: Test on ONE strategy first, catastrophic if wrong"
echo ""
echo "âŒ BAD: 'Add weekend bypass logic for all strategies'"
echo "   Result: 21-38% win rate, -13 to -20% losses"
echo "   Lesson: Test on ONE strategy first, validate hypothesis"
echo ""

echo "ðŸ“ Step 9: Document Learnings"
echo "-----------------------------"
echo "After testing, update CLAUDE.md with:"
echo "  - Hypothesis: What you expected to improve"
echo "  - Implementation: What you changed"
echo "  - Results: Actual metrics (before/after)"
echo "  - Conclusion: Deploy, rollback, or iterate"
echo ""
echo "If change succeeded â†’ Add to best practices"
echo "If change failed â†’ Add to 'Bad Ideas Hall of Shame'"
echo ""

echo "ðŸŽ¯ Remember: Single strategy testing = Risk management"
echo "   One bad universal change can destroy ALL bot performance."
echo "   One good tested change can improve ALL bots systematically."
