#!/bin/bash
# Custom Claude Code command for AI cost monitoring
# Usage: /verify-ai-costs

set -e

echo "üí∞ NexusMeme AI Cost Analysis"
echo "=============================="
echo ""

echo "ü§ñ Step 1: Current AI Configuration"
echo "-----------------------------------"
echo "Environment: ${NODE_ENV:-development}"
echo "AI Model: ${AI_TRADE_DECISIONS_MODEL:-gpt-4o-mini}"
echo "Cache TTL: ${AI_PRESET_CACHE_TTL_MS:-3600000}ms ($(( ${AI_PRESET_CACHE_TTL_MS:-3600000} / 60000 )) minutes)"
echo "Min Confidence Threshold: ${AI_MIN_CONFIDENCE_THRESHOLD:-70}%"
echo ""

echo "üíµ Step 2: Cost Estimates per 1000 Trades"
echo "-----------------------------------------"
echo "Localhost (Development):"
echo "  Model: gpt-4o-mini"
echo "  Cache: 1 hour (3600000ms)"
echo "  Estimated Cost: ~\$2-5 per 1000 trades"
echo "  Savings: 90-95% vs production"
echo ""
echo "Production (Railway):"
echo "  Model: gpt-4o"
echo "  Cache: 2 minutes (120000ms)"
echo "  Estimated Cost: ~\$40-60 per 1000 trades"
echo "  Quality: Higher accuracy, better regime detection"
echo ""

echo "üìä Step 3: Cost Optimization Strategies"
echo "---------------------------------------"
echo "Current Optimizations:"
echo "  ‚úÖ Candle-close gating (4h strategies) - 75% reduction"
echo "  ‚úÖ DropGuard pre-screening - Blocks obvious rejects before AI"
echo "  ‚úÖ AI result caching - Reduces duplicate calls"
echo "  ‚úÖ Request coalescing - Batches similar requests"
echo ""

echo "üéØ Step 4: Expected AI Usage per Strategy"
echo "-----------------------------------------"
echo "1h Timeframe (More Frequent):"
echo "  - Entry validations: ~50-100 per day"
echo "  - Exit optimizations: ~20-40 per day"
echo "  - Pyramid validations (L2+): ~10-20 per day"
echo "  - Total AI calls: ~80-160 per day"
echo ""
echo "4h Timeframe (Less Frequent):"
echo "  - Entry validations: ~15-25 per day"
echo "  - Exit optimizations: ~8-15 per day"
echo "  - Pyramid validations (L2+): ~5-10 per day"
echo "  - Total AI calls: ~28-50 per day"
echo ""

echo "‚ö° Step 5: Cost Control Features"
echo "-------------------------------"
echo "DropGuard (Zero AI Cost):"
echo "  - BTC 15m momentum <-1% ‚Üí Block entry"
echo "  - Spread widening ‚Üí Block entry"
echo "  - Volume panic (1.5√ó drop) ‚Üí Block entry"
echo "  - Impact: Blocks 15-25% of trades before AI validation"
echo ""
echo "Certainty Override (Bypass AI):"
echo "  - ADX >30 + BTC >+1.5% + Volume >2.5√ó"
echo "  - Impact: Saves AI costs on obvious strong signals"
echo ""

echo "üìà Step 6: Cost vs Performance Trade-off"
echo "----------------------------------------"
echo "Win Rate Impact of AI:"
echo "  Without AI: 45-50% win rate"
echo "  With AI (70% threshold): 65-70% win rate"
echo "  Delta: +15-20 percentage points"
echo ""
echo "ROI Analysis:"
echo "  AI Cost: \$40-60 per 1000 trades"
echo "  Win Rate Improvement: +15-20%"
echo "  Expected Value Increase: +\$200-400 per 1000 trades (est.)"
echo "  Net Benefit: +\$140-360 per 1000 trades"
echo ""
echo "‚úÖ Conclusion: AI is an INVESTMENT, not an expense"
echo ""

echo "üîß Step 7: Fine-Tuning AI Thresholds"
echo "------------------------------------"
echo "Current Thresholds:"
echo "  Base: ${AI_MIN_CONFIDENCE_THRESHOLD:-70}%"
echo "  Range Lane: 45% (choppy markets)"
echo "  Green Lane: 45% (strong uptrends)"
echo "  Dip Lane: 40% (buying dips)"
echo ""
echo "Recommendation:"
echo "  - Keep base at 70% for quality"
echo "  - Adjust lanes based on regime (already implemented)"
echo "  - Monitor win rate vs AI costs weekly"
echo "  - Target: 65%+ win rate for profitability"
echo ""

echo "üìù Remember: Lowering AI thresholds globally = more trades but lower expectancy!"
echo "   See CLAUDE.md 'Bad Ideas Hall of Shame #3' for details."
