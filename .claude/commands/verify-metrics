#!/bin/bash
# Custom Claude Code command for profitability metrics validation
# Usage: /verify-metrics [bot_id_or_port]

set -e

BOT_ID=$1

echo "üìä NexusMeme Profitability Metrics Validator"
echo "============================================="
echo ""

if [ -z "$BOT_ID" ]; then
  echo "Usage: /verify-metrics <bot_id_or_port>"
  echo ""
  echo "Example: /verify-metrics 8936"
  echo "         /verify-metrics bot_fb098029-7d8b-40f3-a2d2-df882bb708f2"
  echo ""
  echo "This command validates if a bot meets NexusMeme profitability targets."
  exit 1
fi

echo "üéØ Target Metrics for Production Deployment"
echo "-------------------------------------------"
echo "1. Expectancy: >+1.0% per trade"
echo "   - Great: +2-3%"
echo "   - Good: +1-2%"
echo "   - Minimum: +0.5%"
echo ""
echo "2. Profit Factor: >1.5"
echo "   - Great: >2.5"
echo "   - Good: >1.8"
echo "   - Minimum: 1.5"
echo ""
echo "3. Max Drawdown: <15% from peak equity"
echo "   - Great: <8%"
echo "   - Good: <12%"
echo "   - Maximum: 15%"
echo ""
echo "4. Win Rate (Strategy-Specific):"
echo "   - Trend: 35-45%"
echo "   - Range: 60-75%"
echo "   - Hybrid: 50-60%"
echo ""

echo "üìà Calculating Expectancy Formula"
echo "---------------------------------"
echo "Expectancy = (Win Rate √ó Avg Win) - (Loss Rate √ó Avg Loss)"
echo ""
echo "Example:"
echo "  70% WR √ó +0.5% avg = +0.35% expectancy (POOR - too conservative)"
echo "  40% WR √ó +8% avg - 60% √ó 3% avg = +1.4% expectancy (EXCELLENT)"
echo ""

echo "üîç Fetching Bot Metrics for: $BOT_ID"
echo "------------------------------------"
echo "Note: This is a manual validation tool."
echo "      Please check the following via dashboard or API:"
echo ""
echo "Manual Checks Required:"
echo "  1. Visit bot dashboard (test-scripts-monitor or production)"
echo "  2. Locate bot by ID/port: $BOT_ID"
echo "  3. Review trade history (minimum 20-30 trades for statistical validity)"
echo "  4. Calculate metrics:"
echo ""
echo "     Win Rate = (Winning Trades / Total Trades) √ó 100"
echo "     Avg Win = Sum of Winning Trades / Number of Wins"
echo "     Avg Loss = Sum of Losing Trades / Number of Losses"
echo "     Expectancy = (WR √ó Avg Win) - ((1 - WR) √ó Avg Loss)"
echo "     Profit Factor = Total Wins / Total Losses"
echo "     Max Drawdown = (Peak Equity - Lowest Equity) / Peak Equity √ó 100"
echo ""

echo "‚úÖ Approval Criteria for Production Deployment"
echo "----------------------------------------------"
echo "ALL of the following must be true:"
echo "  ‚úÖ Expectancy >+1.0% per trade"
echo "  ‚úÖ Profit Factor >1.5"
echo "  ‚úÖ Max Drawdown <15%"
echo "  ‚úÖ Win Rate meets strategy-specific target"
echo "  ‚úÖ Minimum 20-30 trades for statistical validity"
echo "  ‚úÖ At least 24-48 hours of dry-run data"
echo ""

echo "‚ùå Red Flags (DO NOT Deploy)"
echo "---------------------------"
echo "  ‚ùå Expectancy negative or <+0.5%"
echo "  ‚ùå Profit Factor <1.2"
echo "  ‚ùå Max Drawdown >20%"
echo "  ‚ùå Win Rate significantly below target (e.g., 33% for trend strategy)"
echo "  ‚ùå Too few trades (<20) for statistical confidence"
echo "  ‚ùå Recent losing streak (>3 consecutive losses)"
echo ""

echo "üìù Example: Port 8936 Analysis (From CLAUDE.md)"
echo "-----------------------------------------------"
echo "BEFORE Fix (Bad Performance):"
echo "  - Win Rate: 33% (target: 50-60%)"
echo "  - Expectancy: -2.98% (target: >+1.0%)"
echo "  - Profit Factor: 0.15 (target: >1.5)"
echo "  - Verdict: ‚ùå FAILED - DO NOT DEPLOY"
echo ""
echo "Root Causes Identified:"
echo "  1. Stoploss too loose (-4% instead of -1.5%)"
echo "  2. DropGuard threshold too high (2.25√ó instead of 1.5√ó)"
echo "  3. Profit targets too conservative (cutting winners early)"
echo "  4. Erosion caps too loose (allowing too much giveback)"
echo ""
echo "AFTER Fix (Expected Performance):"
echo "  - Win Rate: 55-60%"
echo "  - Expectancy: +1.5%"
echo "  - Profit Factor: >1.8"
echo "  - Verdict: ‚úÖ APPROVED for production"
echo ""

echo "üîß Troubleshooting Low Performance"
echo "----------------------------------"
echo "If metrics don't meet targets, check:"
echo "  1. src/utils/StrategyPresets.ts - Are parameters optimized?"
echo "  2. DropGuard settings - Is volume_panic_min too high?"
echo "  3. Stoploss values - Too tight or too loose?"
echo "  4. Profit targets - Are we cutting winners too early?"
echo "  5. AI confidence threshold - Too low (noise) or too high (missed opportunities)?"
echo ""

echo "üìö Reference: See CLAUDE.md for detailed performance targets and troubleshooting"
